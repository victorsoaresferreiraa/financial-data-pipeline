# teste_api.py - Cliente para testar nossa API
import requests
import json
from datetime import datetime

class TesteAPIFinanceira:
    """Cliente para testar nossa API profissionalmente"""
    
    def __init__(self, base_url="http://localhost:8000"):
        self.base_url = base_url
        print("ğŸ§ª TESTADOR DA API FINANCEIRA")
        print("=" * 50)
    
    def testar_status(self):
        """Testa se API estÃ¡ online"""
        print("\n1ï¸âƒ£ Testando status da API...")
        try:
            response = requests.get(f"{self.base_url}/")
            if response.status_code == 200:
                data = response.json()
                print(f"âœ… API online! VersÃ£o: {data['version']}")
                return True
            else:
                print(f"âŒ API offline: {response.status_code}")
                return False
        except Exception as e:
            print(f"âŒ Erro ao conectar: {str(e)}")
            return False
    
    def testar_health_check(self):
        """Testa health check"""
        print("\n2ï¸âƒ£ Testando health check...")
        try:
            response = requests.get(f"{self.base_url}/health")
            if response.status_code == 200:
                data = response.json()
                print(f"âœ… Sistema saudÃ¡vel!")
                print(f"   ğŸ“Š Total de aÃ§Ãµes no banco: {data['total_acoes_banco']}")
                return True
            else:
                print(f"âŒ Health check falhou: {response.status_code}")
                return False
        except Exception as e:
            print(f"âŒ Erro no health check: {str(e)}")
            return False
    
    def testar_acao_individual(self, codigo="AAPL"):
        """Testa extraÃ§Ã£o de aÃ§Ã£o individual"""
        print(f"\n3ï¸âƒ£ Testando aÃ§Ã£o individual: {codigo}...")
        try:
            response = requests.get(f"{self.base_url}/acoes/{codigo}")
            if response.status_code == 200:
                data = response.json()
                print(f"âœ… Dados de {codigo} extraÃ­dos!")
                print(f"   ğŸ“ˆ {data['nome']}: R$ {data['preco']} ({data['variacao']:+.2f}%)")
                print(f"   ğŸ“Š Volume: {data['volume']:,}")
                print(f"   ğŸ”— Fonte: {data['fonte']}")
                return data
            else:
                print(f"âŒ Erro ao obter {codigo}: {response.status_code}")
                return None
        except Exception as e:
            print(f"âŒ Erro ao testar {codigo}: {str(e)}")
            return None
    
    def testar_analise_portfolio(self):
        """Testa anÃ¡lise completa de portfolio"""
        print(f"\n4ï¸âƒ£ Testando anÃ¡lise de portfolio...")
        
        portfolio_teste = {
            "simbolos": ["AAPL", "MSFT", "PETR4.SA", "VALE3.SA"],
            "incluir_historico": False
        }
        
        try:
            response = requests.post(
                f"{self.base_url}/portfolio/analisar",
                json=portfolio_teste,
                timeout=60  # Timeout maior para processamento
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"âœ… Portfolio analisado com sucesso!")
                
                stats = data['estatisticas']
                print(f"\nğŸ“Š ESTATÃSTICAS DO PORTFOLIO:")
                print(f"   ğŸ’° Valor mÃ©dio: R$ {stats['preco_medio']}")
                print(f"   ğŸ“ˆ VariaÃ§Ã£o mÃ©dia: {stats['variacao_media']:+.2f}%")
                print(f"   ğŸ’¹ Volume total: {stats['volume_total']:,}")
                
                perf = data['performance']
                print(f"\nğŸ† PERFORMANCE:")
                print(f"   ğŸ¥‡ Melhor: {perf['melhor_acao']['codigo']} (+{perf['melhor_acao']['variacao']:.2f}%)")
                print(f"   ğŸ“‰ Pior: {perf['pior_acao']['codigo']} ({perf['pior_acao']['variacao']:+.2f}%)")
                
                if data['recomendacoes']:
                    print(f"\nğŸ’¡ RECOMENDAÃ‡Ã•ES:")
                    for rec in data['recomendacoes']:
                        print(f"   {rec}")
                
                return data
            else:
                print(f"âŒ Erro na anÃ¡lise: {response.status_code}")
                print(f"   Detalhes: {response.text}")
                return None
                
        except Exception as e:
            print(f"âŒ Erro ao testar portfolio: {str(e)}")
            return None
    
    def testar_historico(self):
        """Testa consulta de histÃ³rico"""
        print(f"\n5ï¸âƒ£ Testando histÃ³rico do banco...")
        try:
            response = requests.get(f"{self.base_url}/portfolio/historico?limite=10")
            if response.status_code == 200:
                data = response.json()
                print(f"âœ… HistÃ³rico consultado!")
                print(f"   ğŸ“Š Total de registros: {data['total_registros']}")
                
                if data['dados']:
                    print(f"   ğŸ“… Ãšltima atualizaÃ§Ã£o: {data['ultima_atualizacao']}")
                    print(f"\nğŸ“‹ ÃšLTIMOS REGISTROS:")
                    for i, registro in enumerate(data['dados'][:5], 1):
                        print(f"   {i}. {registro['codigo']} - R$ {registro['preco']} ({registro['fonte']})")
                
                return data
            else:
                print(f"âŒ Erro no histÃ³rico: {response.status_code}")
                return None
        except Exception as e:
            print(f"âŒ Erro ao testar histÃ³rico: {str(e)}")
            return None
    
    def executar_todos_testes(self):
        """Executa bateria completa de testes"""
        print("ğŸš€ INICIANDO BATERIA COMPLETA DE TESTES")
        print("=" * 50)
        
        resultados = {
            "status": self.testar_status(),
            "health": self.testar_health_check(),
            "acao_individual": self.testar_acao_individual("AAPL"),
            "portfolio": self.testar_analise_portfolio(),
            "historico": self.testar_historico()
        }
        
        print("\n" + "=" * 50)
        print("ğŸ“Š RESULTADO DOS TESTES:")
        print("=" * 50)
        
        sucessos = sum(1 for v in resultados.values() if v)
        total = len(resultados)
        
        print(f"âœ… Sucessos: {sucessos}/{total}")
        for teste, resultado in resultados.items():
            status = "âœ… PASSOU" if resultado else "âŒ FALHOU"
            print(f"   {teste}: {status}")
        
        if sucessos == total:
            print(f"\nğŸ‰ TODOS OS TESTES PASSARAM!")
            print(f"ğŸš€ Sua API estÃ¡ funcionando perfeitamente!")
        else:
            print(f"\nâš ï¸ Alguns testes falharam. Verifique se a API estÃ¡ rodando.")
        
        return resultados

def main():
    """FunÃ§Ã£o principal de teste"""
    testador = TesteAPIFinanceira()
    
    # Executar todos os testes
    resultados = testador.executar_todos_testes()
    
    print("\n" + "=" * 50)
    print("ğŸ¯ PRÃ“XIMOS PASSOS:")
    print("=" * 50)
    print("1. Acesse http://localhost:8000/docs para ver a documentaÃ§Ã£o")
    print("2. Teste endpoints manualmente no Swagger UI")
    print("3. Verifique arquivos gerados em data/ e reports/")
    print("4. Pronto para GitHub! ğŸš€")

if __name__ == "__main__":
    main()